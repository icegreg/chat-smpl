# Docker Compose для Load Testing
# Включает k6, Grafana, InfluxDB для визуализации результатов

services:
  # InfluxDB для хранения метрик k6
  influxdb:
    image: influxdb:1.8
    container_name: loadtest-influxdb
    ports:
      - "8086:8086"
    environment:
      - INFLUXDB_DB=k6
      - INFLUXDB_HTTP_AUTH_ENABLED=false
    volumes:
      - influxdb-data:/var/lib/influxdb
    networks:
      - loadtest-network

  # Grafana для визуализации
  grafana:
    image: grafana/grafana:latest
    container_name: loadtest-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - influxdb
    networks:
      - loadtest-network

  # k6 runner with host network for WebSocket access
  k6:
    image: grafana/k6:latest
    container_name: loadtest-k6
    working_dir: /scripts
    volumes:
      - .:/scripts:ro
    environment:
      - K6_OUT=influxdb=http://localhost:8086/k6
      - BASE_URL=http://127.0.0.1:8888
      - WS_URL=ws://127.0.0.1:8000
    network_mode: host
    # Команда передаётся при запуске
    entrypoint: ["k6"]
    command: ["run", "--vus", "10", "--duration", "30s", "api-load-test.js"]
    profiles:
      - test

  # Toxiproxy для имитации сетевых проблем на стороне сервера
  toxiproxy:
    image: ghcr.io/shopify/toxiproxy:latest
    container_name: loadtest-toxiproxy
    ports:
      - "8474:8474"   # API
      - "18888:18888" # Proxy для api-gateway
      - "15432:15432" # Proxy для PostgreSQL
      - "15672:15672" # Proxy для RabbitMQ
    networks:
      - loadtest-network
    profiles:
      - chaos

volumes:
  influxdb-data:
  grafana-data:

networks:
  loadtest-network:
    driver: bridge
